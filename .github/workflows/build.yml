name: Node CI

on: [push]

jobs:
  build:

    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macOS-latest]
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@master
    - name: Use Node.js 11.x
      uses: actions/setup-node@v1
      with:
        version: 11.x
    - name: npm install, build, and test
      run: |
        npm install
        npm test
        npm run build
      shell: bash
      env:
        GITHASH: ${GITHUB_SHA}

    - name: Build Linux artifacts
      if: matrix.os == 'ubuntu-latest'
      run: npm run build:linux
      env:
        GITHASH: ${GITHUB_SHA}
    - name: Build Windows artifacts
      if: matrix.os == 'windows-latest'
      run: npm run build:win
      env:
        GITHASH: ${GITHUB_SHA}
    - name: Build Mac OS artifacts
      if: matrix.os == 'macOS-latest'
      run: npm run build:macos
      env:
        GITHASH: ${GITHUB_SHA}

    - name: Create release
      id: create_release
      uses: actions/create-release@master
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Nuclear ${{ github.ref }}
        draft: true
        prerelease: true
    - name: Upload Linux .deb
      id: upload_artifacts
      uses: actions/upload-release-asset@v1.0.1
      if: matrix.os == 'ubuntu-latest'
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHASH: ${GITHUB_SHA}
      with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./packages/app/release/nuclear-${GITHUB_SHA}.deb
          asset_name: nuclear-${GITHUB_SHA}.deb
          asset_content_type: application/vnd.debian.binary-package
